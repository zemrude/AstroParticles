# Multimessenger Astronomy 

## The Beam Dump

Cosmic ray accelerated are typically surrounded by a radiation field and matter eventually interacting and producing secondary particles. The picture is similar to that of beam dumps in particle accelerators at Earth, where a beam of particles is aimed at a specific target. Among the secondary particles produced we have gamma-rays and neutrinos both of them will point to the accelerators.

![](images/beam_dump.svg)

A cosmic-ray source it is said to be opaque or **optically thick** if photons and protons cannot escape from the source without lossing all or most of their energy. Alternatively a transparent source it is said to be **optically thin**. A source that is very optically thick won't be visible in any messenger except neutrinos. We call those source *hidden sources*.

## Gamma-ray Astronomy

As we saw, the origin of CR remains a mystery due to the deflection of CRs in their travel. Only CR astronomy at $10^{19}$ eV will be possible if the composition of these UHECR are protons, but even in this case the GZK limits the horizon. 

Gamma-ray astronomy provides an fundamental tool to observe the Universe using neutral deep penetrating gamma-ray particles. Originally the distinction between gamma-rays and X-rays was due to the nuclear production mechanism. X-rays are the product of transition of electrons in the atomic shell, while gamma-rays are produced in the atomic nucleus. This distinction also leads to a classification in energy. X-rays are typically below 100 keV. Photons with E > 100 keV are called gamma-rays. 

![Source: Wikipedia](images/EM_spectrum.svg)

### Spectral Energy Distribution

In gamma-ray astronomy is usual to study an object emission by its spectral energy distribution (SED).  The SED on an object is its energy emitted plotted against some measure of the photon - frequency or wavelength. The reason astronomers do this is to see how much energy is produced by the object as a function of frequency or wavelength. The SED is typically characterized by $\nu F_\nu$ and it is measured in units of ergs $\mathrm{cm}^{-2}\; \mathrm{s}\;^{-1}$, ie. it indicates the rate of energy emitted per surface. The function $F_\nu$ is the flux density which indicates the rate of energy emitted per surface and also per frequency, so it is expressed as ergs $\mathrm{cm^{-2}\; s^{-1}\; Hz^{-1}}$. All of this doesn't need to be confused with the spectrum! which is what we are being using to characterize CRs. In CR physics spectrum in the rate of particles per unit energy and surface and it is measured on $\mathrm{GeV^{-1}\; cm^{-2}\; s^{-1}}$. The spectrum multiply by energy, gives you the rate of particles per unit surface. Multiplying again by energy give use the energy rate per unit surface. Therefore we have the relation:

$$\nu F_\nu = E^2 \frac{\mathrm{d}N}{\mathrm{d}E}$$

### Gamma-ray production mechanism
Sources of CR can also produce gamma-rays by different mechanisms roughly divided in two main categories:

#### Leptonic models: 
In this models only leptons (mostly electrons) will produce gamma-ray emission. The mechanismare mostly:
   * **Synchrotron radiation.** 
   * **Inverse Compton Scattering.**

#### Hadronic model:
In hadronic models, gamma-rays are produced as a result of acceleration to high energies of protons or other hadrons. The mechanism of gamma-ray production in hadronic models are mainly:
   * **$\pi^0$ decay.** 
   * **Proton synchrotron radiation.** 

Another categories for gamma-ray production can some exotic models like dark matter annihilaiton, or matter-antimatter annihilation and nuclear transformation.

### Leptonic models

#### Synchrotron radiation

Synchrotron radiation is extremely important for astrophysics as it was realized by Shklovskii in 1957 when studing the non-thermal emission of the Crab remnant. In order to understand better the synchrotron radiation we will have to dig in a bit in electromagnetism. We already saw that a charge particle of charge $q$, for example an electron, moving with velocity $v$ in a magnetic field $\vec{B}$ feels an an external force:

$$\vec{F} = \frac{q}{c}(\vec{v}\times \vec{B}) $$

Now, because of the force on the particle is perpendicular to the motion, the magnetic field cannot do work on the particle, and so its speed does not change, i.e. $|v|$ = constant, but there is an acceleration since the direction will change. On the other hand an accelerated electrical charge radiates electromagnetic waves! which... will slow down the particle... 

The reason of this aparent inconsistency comes from the fact that we treat the electric field lines as the purely Coulombic action-at-a-distance. In reality we have to take into account that as a particle moves, the electric field lines need to *re-arrange* and this re-arrangement cannot happen at a speed faster than the speed of light. 

Here are going to derive the radiation emission for a particle with an acceleration and we are going to do it by messing around with the Coulomb fields. For a more formal argument derived from Maxwell equations you can see the book of Longair.

Let's assume that the particle is at rest at the moment $t=0$. The electric field lines clearly point away from the origin. At that moment the particle accelerates which brings the velocity of the particle to $\Delta v$ in a time $\Delta t$, after that the particle continues with uniform velocity. 

![](images/bremsstrahlung.svg)

After a certain time, the particle will be in the position $t\Delta v$. In a sphere located far way (with a radius larger than $c t$), the electric field lines are still those of the stacionary particle, since they field lines cannot "know" yet that the particle has moved, so the point radially towards the origin at $t=0$. Inside a sphere of radius $c(t - \Delta t$), the electric field lines are already those from the electron that moves at a constant velocity.

The perturbation of the electric field lines needs to propagate radially, this *kink* is nothing more than a radiation! From simple geometry relations we can get that:

$$\frac{E_\theta}{E_{r}} = \frac{\Delta v  t \sin\theta}{c\Delta t} = \frac{r \sin \theta}{c^2}\frac{\Delta v}{\Delta t}$$

where $r = c t$, and $E_r$ is simply the Coulomb field $E_r = q/4\pi\epsilon_0 r^2$ or in [gaussian units](https://en.wikipedia.org/wiki/Gaussian_units) since the kink is really small and the eletric field along the kink remains the same $E_r = q/r^2$ and therefore the transverse component becomes:

$$E_\theta = \frac{q a \sin\theta}{c^2 r}$$

where we used the fact that $\Delta v/\Delta t$ is just the acceleration $a$. An interesting fact appears here, $E_\theta$ depends on $r^{-1}$ and  not $r^{-2}$ so for larger $r$, $E_\theta$ is going to dominate over $E_r$.  Accompanying this transverse electric field there will be a magnetic field, which is a property of an electromagnetic wave. In other words, an electromagnetic pulse is generated by the accelerated charge particle. Since this is an electromagnetic radiation there is an energy flow per unit area, per second and the direction is given by the Poynting vector (with $|E|=|B|$ as in electromagnetic wave):


$$\vec{S}  = \frac{c}{4\pi}(\vec{E}\times\vec{B})$$

Which points in the radial direction. In this case can be reduced to:

$$|S| \equiv \frac{ \mathrm{d}E}{\mathrm{d}t \mathrm{d}A} = \frac{c}{4\pi} E^2_\theta \vec{n}$$

Which is the energy flow per unit area per second. The unit area $\mathrm{d}A$ can be rewritten in terms of the solid angle as $\mathrm{d} A= r^2\mathrm{d}\Omega$, and so the rate of energy loss through the area subtended by the solid angle $\mathrm{d} \Omega$ at distance $r$ is given by:

$$\left(\frac{\mathrm{d}E}{\mathrm{d}t \mathrm{d} \Omega}\right)_{rad}  = \frac{q^2a^2 \sin^2 \theta}{4\pi c^3}$$

Notice that this energy loss rate follows a *dipole* pattern $\mathrm{d}P/\mathrm{d}\Omega \propto \sin^2 \theta$ and that $\theta$ is defined along the acceleration line. If we now integrate over all solid angles we obtain that the emitted power is given by:


$$P \equiv -\left(\frac{\mathrm{d}E}{\mathrm{d}t}\right)_{rad} = \frac{2q^2 a^2 }{3c^3}$$

Which is call the *Larmor's formula*. Note that this is valid for any form of acceleration $a$.


In the relativistic case this formula can be rewritten as:

$$P  = \frac{2q^2}{3c^3} \gamma^4 [ \gamma^2 a_{\parallel}^2 + a^2_{\perp}] $$ 



### Single-electron in uniform magnetic field

In an uniform magnetic field, a high energy charged particle, for example an electron, moves in spiral path at a constant *pitch angle*, $\alpha$.

![](images/spiral.svg)

Its velocity along the field lines is constant $v_{\parallel} = v \cos\alpha = \mathrm{const.}$, but its circular component $v_\perp = v\sin\alpha$. Let's first attack the non-relativistic case.

#### Non relativistic case: Cyclotron radiation

From Newton's law and the Lorentz force we have that:

$$ m_e a_\perp = m_e \frac{v_\perp^2}{r_{gyr}} = \frac{e v_\perp B}{c}$$ 

where $r_{gyr}$ is the gyroradius which can be written as:

$$r_{gyr} = \frac{v_\perp}{\omega_{gyr}} = \frac{v\sin\alpha}{\omega_{gyr}}$$

where we can define the gyrofrecuency as:

$$\omega_{gyr} \equiv \frac{eB}{m_e c}$$

Therefore according to the Larmor's equation of power emitted we can write:

$$P = \frac{2 e^2}{3c^3} \omega_{gyr}^2 v^2\sin^2\alpha$$

Note the Larmor formula does not tell us frequency spectrum, but if a particle is moving in a circular motion, then from an observer far way, the "aparent" motion will be sinosoidal as illustrated in the figure below. 

![](images/cyclotron.svg)

In particular since the power $P$ depends on  $|v^2|$ for a distance in the $x-y$ plane, power will varie as $\sin^2(\omega_{gyr}t)$ and so the electric field line will change as $E(t)\propto \sin(\omega_{gyr}t)$. The radiated emission will appear as *monochromatic* with an angular frequency given precisely by the particle circular frequency $\omega_{gyr}$. This is the known as the *cyclotron* radiation. In this case the dipole emission pattern is turning around with the particle and an observer in the laboratory frame will see the same frequency. As a consequence also the radiation is independent of the viewing angle. 

#### Relativistic case: Synchrotron radiation.

Things are slighly different when we consider the relativistic case where electrons move at $\beta \rightarrow 1$. Using again Newton's law with the Lorentz force we have:

$$\gamma m_e \frac{\mathrm{d} v_\perp}{\mathrm{d} t} = \frac{e v_\perp B}{c}$$ 

where we can obtain the perpendicular acceleration as:

$$a_\perp = \frac{e v\sin\alpha}{\gamma m_e c}$$


where now the electrons's relatisvistic angular gyroradius frequency is given by:


$$\omega^{rel}_{gyr} \equiv \frac{eB}{\gamma m_e c}$$

which is exactly related to the classical angular frequency as $\omega_{gyr}/\gamma$. According to the relativistic Larmor's formula above we have that:

$$P = \frac{2 e^2}{3c^3} \gamma^4 \left(\frac{e v\sin\alpha}{\gamma m_e c}\right)^2 $$

We can re-arrange this formula by assuming ultra-relativistic electrons $\beta \rightarrow 1$ and that we have an average number of electrons with different pitch angles and so $\langle \sin^2 \alpha \rangle = 2/3$. We are going also to use the definition of the Thomson cross-section:

$$\sigma_T \equiv \frac{8\pi}{3}r^2_0$$ 

where $r_0$ is the electron classic radius defined (in gaussian units) as:

$$r_0 = \frac{e^2}{m_e c^2} $$

with that we can write the power loss as:

$$P = \frac{4}{3} \sigma_T c U_B \gamma^2$$

where $U_B = B^2/8\pi$ is the magnetic field energy density. The power depends on the electron mass via the Thomson cross-section and the $\gamma$. In total it gives $P\propto m_e^{-4}$ for the electrons. That's why for protons the syncrotron radiation is not as important as it is for electrons. The mean free-path for electrons given their losses sue to synchrotron is (for typical astrophysical values):

$$l_{syn} = \left(\frac{1}{E}\frac{\mathrm{d}E}{\mathrm{d}t}\right)^{-1}  \sim 100 \mathrm{\;pc}$$

That's the reason why electrons are not the main component of CR since the cannot travel long distances. 
If we want now to derive the power emitted per frequency, things get also a bit more complicated. One first thing to take into account is that in the relativistic regime the power radiated will be distorted. From Lorentz transformations we can derive that an angle $\Psi$ in the particle rest frame will be seen in laboratory frame as:

$$\sin \Psi = \frac{\sin\Psi^\prime}{\gamma(1+\beta \cos\Psi^\prime)}$$ 

(we saw this in the Exercises 1). For small angles we have that 

$$\sin \Psi \sim \Psi \sim \frac{1}{\gamma}$$

i.e, while the power is radiated nearly isotropically (dipole) in the particle's instantaneus rest frame, most of it will be *beamed* into a narrow cone of angle $\sim 1/\gamma$ in the laboratory frame. Note that I'm referring to an *instantaneous* rest frame, what does it even mean? Well it means that I in the particle rest frame, where the velocity of the particle is 0, the acceleration on the other hand is not 0, so eventually the particle will move. Ie, there is no particle rest frame, but there is an instantaneous rest frame.

This beaming in the lab reference frame has an impact on how the viewer sees the electric field variation. It is no longer a sinusoidal, instead the emission is pulsed every time the cone sweeps around the line of sight of an observer as illustrated below:


![](images/synchrotron_0.svg)


Since each cone beaming has a half amplidude of $1/\gamma$ the radiation from an observer is visible during a $\Delta \theta \sim 2/\gamma$. During this angular distance the particle travels from $A$ to $B$ at an angular frequency given by $\omega_{gyr}^{rel}$ which means that $\Delta t_{AB}$ is given by:

$$\Delta t_{AB} = \frac{\Delta \theta}{\omega_{gyr}^{rel}} = \frac{2}{\gamma \omega_{gyr}^{rel}}$$

Given the relativistic speed of the the electron, the frequency of the radiation is no longer a sinusoidal. When a photon is emitted at the point $B$ the photon emitted in $A$ has already travelled a distance $c\Delta t_{AB}$. Therefore the time interval between photons is given by:


$$\Delta t_{sync} = \frac{c\Delta t_{AB} - v_\perp \Delta t_{AB}}{c} \approx \Delta t_{AB}( 1 - \beta) \approx  \Delta t_{AB} \frac{1 - \beta^2}{1 + \beta} $$

$$ \Delta t_{sync} \approx \frac{ \Delta t_{AB} }{2\gamma^2} = \frac{1}{\gamma^3 \omega_{gyr}^{rel}} = \frac{1}{\gamma^2 \omega_{gyr}} $$

So synchrotron radiation is a very spiky series of widely spaced narrow pulses of time $2\Delta t_{sync}$, and adjacent spikes are separated in frequency $\Delta t_{gyr} = 1/\nu^{rel}_{gyr} = \gamma/\nu_{gyr}$. The emission from an observer is illustrated below:

![](images/synchrotron_1.svg)

The power spectrum (ie power as function of frequency) illustrated in the plot on the right is no long a monochromatic sinusoidal signal, but the Fourier transform of this time series of pulses. Taking of all the Fourier components into account results in the following expression for one electron (the formal derivation can be found for example in *Classical Electrodynamics* by J. D. Jackson):

$$P(\nu)\mathrm{d}\nu = \frac{\sqrt{3}e^3B\sin\alpha}{m_ec^2}\frac{\nu}{\nu_c}\int_{\nu/\nu_c}^\infty K_{5/3}(\psi)\mathrm{d}\psi$$

where $K_{5/2}$ is the Bessel function of order 5/2, and we expressed the power spectrum in terms of the frequency $\nu = \nu_{gyr} =\omega_{gyr}/2\pi$ and where we defined the critical frequency as:

$$\nu_c \equiv \frac{3}{2}\gamma^2\nu_{gyr} \sin \alpha$$

which the frequency at which the power spectrum will peak. In general terms we can describe the shape of the synchrotron power spectrum of a single electron has a logarithmic slope at low frequencies as $P \propto \nu^{1/3}$, a broad peak near the critical frequency $\nu_c$, and a sharp fall off at higher frequencies.

#### Spectrum for several electrons for optically thin sources

If a synchrotron source containing any arbitrary distribution of electron energies is optically thin ($\tau \ll 1$), then its spectrum is the superposition of the spectra from individual electrons and its flux density cannot rise faster than $\nu^{1/3}$ at any frequency $\nu$. The energy distribution of cosmic-ray electrons in most synchrotron sources is roughly a power law:

$$n(E) \mathrm{d}E \propto E^{-\delta}\mathrm{d}E$$

We make the very simple and crude approximation that each electron radiates all of its power at a single critical frequency:

$$\nu_c \simeq \gamma^2\nu_{gyr}$$

We can assume that the luminosity or total power emitted per unit volume per unit frequency, $L(\nu)\mathrm{d}\nu$ is given by the power emitted for each individual electron times the number of electrons:

$$ L (\nu) \mathrm{d}\nu = P n(E)\mathrm{d}E = -\left(\frac{\mathrm{d}E}{\mathrm{d}t}\right) n(E)\mathrm{d}E $$

where 
$$E = \gamma m_e c^2 \simeq \left(\frac{\nu}{\nu_{gyr}}\right)^{1/2}m_e c^2$$

and so

$$\frac{\mathrm{d}E}{\mathrm{d}\nu} \simeq \frac{m_e c^2 \nu^{-1/2}}{2\nu_{gyr}^{1/2}}$$

putting all together gives:

$$L_\nu \propto B^{(\delta+1)/2}\nu^{(1-\delta)/2}$$

That is, the synchrotron spectrum of a power-law energy distribution is itself a power law. This idea is represented in the figure below:

![](images/synchrotron_spectrum.svg)


For example in our Galaxy we expect the electron population to have an spectral index of $\delta \sim 2.4$, and so the synchrotron radiation should have an spectral index of $\sim 0.7$. 

#### Power spectrum for several electrons for optically thick sources

The argument of a power law synchrotron spectrum as a power-low with specltral index $\alpha = (1 - \delta)/2$ it's true as long as no absorption of photons by the emitting region happens. At low frequencies however synchrotron suffers from self-absorption, in which a photon interacts with a charge in a magnetic field. This also happens in *optically thick* sources. Therefore at low frequencies its emission is absorbed and re-emitted as blackbody radiation.
The derivation of the synchrotron self-absorption is complicated so we are going to give only an heuristic approach. The problem with the re-emission of low frequencies as a black-body radiation is that a power-law distribution does not have a characteristic temperature. We can however assume that each electrons emits energy at a given frequency (given that the synchrotron emission of individual electrons is highly peak at a given frequency):


$$\nu_c \equiv \frac{3}{2}\gamma^2\nu_{gyr} \sin \alpha$$


in order to calculate an *effective temperature* we can use that for an ultrarelativistic gas we have the relation:

$$E_e = 3kT_e(\nu)$$

where $E_e = \gamma m_e c^2$, since $\gamma \propto \nu^{1/2}$ we have that:

$$T_e(\nu) \propto \nu^{1/2}$$

The black-body radiation or Rayleigh-Jeans is proportional to $\nu^2$ but given the extra dependency of $T_e(\nu)$ it is changed as:

$$L(\nu) \propto T(\nu) \nu^2 B^{-1/2} \sim \nu^{1/2}\nu^{2}B^{-1/2} \sim \nu^{5/2} B^{-1/2}$$

A thing to note is that this part of the spectrum is independent of the orginal electron power-law spectral index.


### Tutorial I. Working with SED

We are going to plot some SED using a python module called [```naima```](https://github.com/zblz/naima). This package allows for the calculation of non-thermal radiation from relativistic particle populations.

```{python}
%matplotlib inline
import numpy as np
import matplotlib.pylab as plt


%config InlineBackend.figure_format = 'svg'
import naima
import astropy.units as u

# First we are going to define a population of electrons with a PowerLaw model                                    
e_pl = naima.models.PowerLaw(1e35*u.Unit('1/eV'), 1*u.TeV, 2.4)

#Now the equivlent synchrotron radiation for a magnetic field of 100 uG
syn = naima.models.Synchrotron(e_pl, B=100*u.uG)


spectrum_energy = np.logspace(-1,16,1000)*u.eV
sed_syn = syn.sed(spectrum_energy, distance=1.5*u.kpc)

fig = plt.figure(figsize=(10,4))
ax = plt.subplot(111)
ax.loglog(spectrum_energy,sed_syn,lw=3,label='Syncrotron')

ax.set_ylim(1e-9, 1e-5)
ax.set_xlabel('Photon energy [{0}]'.format(
        spectrum_energy.unit.to_string('latex_inline')))
ax.set_ylabel('$E^2 dN/dE$ [{0}]'.format(
        sed_syn.unit.to_string('latex_inline')))
ax.grid()
ax.legend(loc='upper right')
plt.show()
```
### Inverse Compton scattering.

Compton discovered that photons can transfer part of their energy to electrons in a collision. In astrophysics the inverse Compton effect electrons accelerated to high energy collide with photons from the blackbody radiation (thermal photons) or starlight photons and transfer energy to them. 

In astrophysics the inverse compton scattering is very important as a fast electrons that produce the synchrotron component can hit a low-energy photon and transfer a large fraction of its energy to the photon. For low energy photons, the scattering is elastic, and this regime is called the classical *Thomson regime*. However, for high energy photons where $E_\gamma \gg m_e c^2$ the scatting is not elastic and the energy of the scattered photons changes. This regime is called the *Klein-Nishina*. The cross-section for this *inelastic* scattering is given by:

$$\frac{\mathrm{ d} \sigma_{KN}}{\mathrm{ d}\Omega} = \frac{r_e^2}{2} \frac{E^2_{\gamma,out}}{E^2_{\gamma,in}}\left(\frac{E_{\gamma,out}}{E_{\gamma,in}} + \frac{E_{\gamma,in}}{E_{\gamma,out}} - \sin^2\theta\right)$$

In the low energy regime $E_{\gamma,in} = E_{\gamma,out}$ and the cross-section approaches that of the Thomson scattering.

#### Maximum energy of inverse Compton

Let's assume the lab reference system, $O$, and the electrons rest frame system $O^\prime$. The energy of the photon is then given by:

$$E_{\gamma,in}^\prime = \gamma E_{\gamma,in} (1 + \beta \cos\theta)$$

where $\gamma$ and $\beta$ refer obviously to the electron. Since in the electron's rest frame the scattering happens at low-energy we can assume that the scattering is described by the elastic Thomson regime, ie, the photon is scattered with the same energy in the electron's rest frame. Going back to the lab frame we have then:

$$E_{\gamma,out} = \gamma E_{\gamma,out}^\prime ( 1 + \beta\cos\theta^\prime)$$

but $E_{\gamma,in}^\prime = E_{\gamma,out}^\prime$. The maximum energy transfer will be that of a head-on collision in which the electron $\cos\theta = \cos \theta^\prime = 1$ is bounced backwards we have that:

$$\nu_{max} = \nu_0 \gamma^2 ( 1 + \beta)^2 \simeq 4 \nu_0 \gamma^2$$

As electrons are moving in an isotropic photon field the will see mostly head on collitions. So the energy spectrum of of scattered photons peak close to the maximum frecuency. This relation is very important for astrophysics, because it tell us a relation between the energy of electrons and the spectrum of photons. We know there are electrons with $\gamma \sim 100 - 1000$ and therefore the resulting photon emission is of very high energy. For example assuming electrons with $\gamma \approx 1000$ we have:


| Waveband | Frequency (Hz) $\nu_0$  | Scattered Frequency (Hz) |
|------|------|------ | 
|   Radio  | $10^9$ |   $10^{15}$ = UV    |
|   Far-infrared  | $3\times10^{12}$ |   $3\times10^{18}$ = X-rays    |
|   Optical  | $4\times10^{14}$ |   $4\times10^{21}$ = $\gamma$-rays    |


The hand-waving argument $\nu \sim \nu_0 \gamma^2$ has also implication on the spectrum of photons. If electrons follow a power-law in the form of:

$$\mathrm{d} n(E) \propto E^{-p} \mathrm{d} E$$

we can derive the spectrum of scattered photons which will follow a power-law as:

$$ I(\nu) \propto \nu^{-\frac{p-1}{2}} $$

because electrons losse energy by a factor $\gamma^2$ and the frequency of photons is $\nu \approx \nu_0 \gamma^2$

::: {.callout-note}
In some cases the synchrotron spectrum can interact with the same electron population that generated them via IC,  scenario is called *Synchrotron Self Compton* (SSC). When external photons are present IC does not need the synchrotron field. Such process is referred as *External Inverse Compton*
:::

### Tutorial II Working with SED

We are going now to calculate the IC spectrum using the CMB as the radiation field:

```{python}
from astropy.constants import c

IC = naima.models.InverseCompton(e_pl, seed_photon_fields=['CMB'])

sed_ic_cbm = IC.sed(spectrum_energy, distance=1.5*u.kpc, seed="CMB")

fig2 = plt.figure(figsize=(10,4))
ax = plt.subplot(111)
ax.loglog(spectrum_energy,sed_syn,lw=3,label='Syncrotron',c=naima.plot.color_cycle[1])

ax.loglog(spectrum_energy,sed_ic_cbm,lw=3,
        label='Inverse Compton CBM', c=naima.plot.color_cycle[2])

ax.set_ylim(1e-12, 1e-5)
ax.set_xlabel('Photon energy [{0}]'.format(
        spectrum_energy.unit.to_string('latex_inline')))
ax.set_ylabel('$E^2 dN/dE$ [{0}]'.format(
        sed_syn.unit.to_string('latex_inline')))
ax.grid()
ax.legend(loc='upper right')
plt.show()
```

#### Case of study: Active Galactic Nuclei

As we saw, blazars are a particular classification of AGNs with their relativistic plasma jet oriented close to the line of sight. Because blazars have their jets pointing towards, the full emission comes from a relatively small region (the width of the jets) and so these objects can exhibit rapid variability (due to the smaller causally connected regions). The typical SED for AGNS is characterized by a synchrotron component extending from radio to X-ray frequencies, and a second component peaking at gamma-ray frequencies due to either inverse-Compton radiation (or from hadronic processes). The plot below shows the spectral energy distribution of nearby (z = 0.044) blazar 1ES 2344+514 during a flaring and a quiet state.

#### Lightcurves and flares

In addition to the SED one could measure the light-curve or number of photons (or energy density) as a function of time. This is usually done to illustrate the variability of the source. For AGNs it is possible to make the lightcurve for different energy ranges, and therefore addressing different emission mechanism. 

Sometimes it is possible to observe  a *flare* in high energy photon range but with no activity detected in soft/hard X-ray. These are called **orphan flare**. This is interesting since in the SSC scenarios the X-rays (due to synchrotron) and TeV gamma-rays (due IC scattering) must be correlated. An orphan flare is therefore an indication that SSC scenario might be excluded, while the EC is still possible. As we will see also an hadronic scenario in which TeV photons come from $\pi^0$ is still possible.

### Hadronic models
#### Pion decay

Accelerated protons in the source can produce charged and neutral pions via proton-proton interaction. In this context a CR proton with energy $E_p$ and momentum $p_p$ interacts with the ISM at rest in the process:

$$ p + p \rightarrow p + p + \pi^0$$ 


There is a threshold for this production given by the invariant:

$$s = E_{CoM}^2 = (E_p + m_p)^2 - p_p^2 = (2m_p^2 + m_{\pi^0}^2)^2 $$

As we saw in lesson 2, the available energy to produce particles can be derived as:

$$\epsilon = E_{CoM} - 2m_p $$

The energy threshod to produce a pion at rest is then:

$$E_{p,th} = \frac{m_{\pi^0}^2 + 4m_p m_{\pi^0} + 2m_p^2}{ 2 m_p} = \frac{m_{\pi^0}^2}{2m_p} + 2 m_{\pi^0} + m_p$$

```{python}
mp = 938.28 #MeV
mpion = 134.976 #MeV
print (f"Kinetic energy threshold for pion production {(mpion**2/(2*mp) + 2*mpion):.1f} MeV")
```

The pions are produced with the same power law as the parent proton. Neutral pions decay rapidly ($\tau = 8.4 \times 10^{-17}$ ns, compared to 26 ns of charged pions) in to two photons. In the CoM each photon from the pion decay has an energy of $E^{*}_\gamma = m_{\pi^0}/2 \approx 70$ MeV as we saw for the 2-body decay. In order to calculate the energy in the lab system we need to make a lorentz transformation:

$$E_\gamma = \gamma(E^{*}_\gamma + \beta_\pi p^{*}_\gamma \cos\theta^{*})$$

where ($^*$) denotes the CoM.  Since pion is an isoscalar the decay is isotropic the limits are determined by $\cos\theta^{*} = \pm 1$. These limits are:

$$\frac{m_{\pi^0}}{2}\sqrt{\frac{1-\beta}{1+\beta}} \leq E_\gamma \leq \frac{m_{\pi^0}}{2}\sqrt{\frac{1+\beta}{1-\beta}}$$

where $\beta$ is the velocity of the parent pion and we used $p^* = E^*$ for photons. 

#### Pion bump

But what is the distribution of photons? Since the decay is isotropic in the CoM:

$$\mathrm{d} N  = \frac{1}{4\pi} d\Omega = \frac{1}{2} \mathrm{d}\cos\theta^*$$

Using the lorentz transformation from CoM system and the lab system we can express: $\mathrm{d}\cos\theta^* = \mathrm{d}E_\gamma/(\gamma \beta_\pi p^*_\gamma) = 2\mathrm{d} E/ (\gamma \beta_\pi m_{\pi^0})$ and thus:

$$\mathrm{d} N = \frac{\mathrm{d} E}{\gamma \beta_\pi m_{\pi^0}}$$ 

Then the distribution of photons $\mathrm{d}N/\mathrm{d}E = \mathrm{\; const.}$ ie is constant on a box from $E_{min}$ to $E_{max}$ when plotted as $\log(E_\gamma)$. If many pions are decaying, the distribution of photons will be superpossition of boxes around $m_{\pi^0}$. This is the so-called *pion bump*.

![](images/pion_bump.png)

### Pion bump in SNR with Molecular Cloud

In 2013 Fermi (a gamma-ray satellite) confirmed the pion-bump in two old SNRs with Molecular Cloud. 

![](https://inspirehep.net/files/6ff98851515f2a9d31b6faabd53dc1b7)

So did we find the sources of Galactic Cosmic Rays? No. The steep gamma-ray spectrum at high energies suggests that the acceleration is not very active any more (as expected from old SNRs) and hence, even though there might be some particle acceleration these are not the sources of Galactic Cosmic Rays. 

### Galactic gamma-ray diffuse emission

Diffuse gamma-ray emission is that not associated with a particular source. 
Fermi-LAT observed gamma-ray counts in the energy range from 200 MeV to 100 GeV. The signal is dominated by the diffuse Galactic emission, which is strongest in the plane of our Galaxy and toward the Galactic center but present all over the sky. The following shows the diffuse gamma-ray emission from 200 MeV to 100 GeV.

The gamma-ray diffuse emission are produced primarly the $\pi^0$ produced by interactions of cosmic rays protons with the ISM. The Inverse Compton scattering on star light is less important as well as bremsstrahlung (braking radiation). In the plot below the models are split into the three basic emission components:

* $\pi^0$-decay (red, long-dashed) 
* IC (green, dashed),
* and bremsstrahlung (cyan, dash-dotted). 

![Source: Taken from [arXiv:1202.4039](http://arxiv.org/abs/1202.4039)](images/GalacticCenter_Fermi.jpg)

### Extragalactic Background Light

As we saw, VHE gamma-rays ($E_\gamma =30$ GeV) have a limited horizon due to their interaction with the CMB and the [Extragalactic Background Light (EBL)](http://en.wikipedia.org/wiki/Extragalactic_background_light). The EBL is difficult to measure directly due to strong foregrounds from our solar system and the Galaxy. The TeV signal of distant AGNs are (partially) absorved at the highest energies by the ELB. The absortion is energy dependent and increases with distance. Observations of very far distant AGNs can be used to put constrains on the amount of EBL. However it is difficult to distinguish between an intrinsic softening of blazar spectra and a softening caused by the interaction with low energy EBL photons. The plot below shows the gamma-ray horizon and measurements from some Imaging Atmospheric Cherenkov Telescopes (IACTs) up to z=0.536.

![Source: Taken from [arXiv:0904.0774v2](http://arxiv.org/abs/0904.0774)](images/ELB.png)

### Gamma-ray Detection
#### The atmosphere


The Earth's atmosphere is opaque to photons with energy above 10 eV, meaning that to observe gamma-rays directly we need to place the detector above the atmosphere. A turning point in gamma-ray astronomy was the launch of the first satellite-borne telescope, SAS-2, in 1972.

![Source: scienceofdoom.wordpress.com](http://scienceofdoom.files.wordpress.com/2009/11/800px-atmospheric_electromagnetic_opacity-svg.png)

The mayor limitation of satellite experiments is their low area which limits their use to $\leq 100$ GeV. At 100 GeV is when electromagnetic showers from the initial photon can be detected in ground-based telescopes.

### Cherenkov emission.
When relativistic particles traverse a medium at a speed greater than the speed of light in that medium it can induce Cherenkov radiation. Cherenkov light is emitted in the UV and blue region in a narrow cone with angle:

![](images/Cherenkov.svg)

$$\cos \theta = \frac{ct/n}{\beta c t} = \frac{1}{\beta n}$$

In the relativistic limit $\beta \sim 1$ we can write:

$$\sin \theta = \sqrt{1 - \frac{1}{n^2}} = \sqrt{\frac{n^2 - 1}{n^2}} = \sqrt{\frac{(n-1)(n+1)}{n^2}} \approx \sqrt{2(n-1)}$$

In the atmosphere the spectral index depends on the altitude (same as density and pressure):

$$n = 1 + \epsilon_0 e^{-h/h_0} $$

where $\epsilon_0 \simeq 2.8 \times 10^{-4}$ at sea level. 

### Tutorial II: Plot of the Cherenkov angle as funcion of the spectral index.

```{python}
diffn = np.logspace(-5, 0, 100) #n - 1 form 0.0001 to 1
fig, ax = plt.subplots(figsize=(5,4))

#lets remove the values that will give errors in the arcsin:
diffn = diffn[np.where(np.sqrt(2*diffn) <= 1.)]

#In the relativistic limit 
ax.plot(diffn, np.degrees(np.arcsin(np.sqrt(2*diffn))))
ax.set_yscale("log")
ax.set_xscale("log")
ax.set_xlabel("n - 1 ")
ax.set_ylabel(r"$\theta_C$ ($^\circ$)")
ax.grid()
plt.show()
thetaw = np.degrees(np.arcsin(np.sqrt(2*(1.33 -1))))
print(r"Cherenkov angle in water: $\theta_C = %.2f^{\circ}$"%thetaw)
#For the atmosphere n = 1.0003
thetaatm = np.degrees(np.arcsin(np.sqrt(2*(1.0003 -1))))
print(r"Cherenkov angle in the atmosphere: $\theta_C = %.2f^{\circ}$"%thetaatm)


```


### Number of photons

The number of photons from Cherenkov radiation follows the *Frank-Tamn* formula:

$$\frac{\mathrm{d}N}{\mathrm{d}x} = 2 \pi \alpha z^2\int_{\lambda_1}^{\lambda_2} \sin^2\theta \frac{\mathrm{d}\lambda}{\lambda^2}$$

For relativistic particles, $\beta \sim 1$ in water $n = 1.33$ the Cherenkov spectrum is: 

```{python}
import scipy.constants as cte
alpha = cte.alpha #fine structure constant

fig, ax = plt.subplots(figsize=(5,4))
wl = np.arange(200, 500,1)
n = 1.33
ax.plot(wl, 2 * np.pi * alpha * ( 1- 1/n**2)/wl**2)
ax.set_xlabel(r"$\lambda$ [nm]")
ax.set_ylabel(r"$\frac{\mathrm{d}N_\gamma}{\mathrm{d}x\mathrm{d}\lambda}$ (photons nm$^{-2}$)")
ax.grid()
plt.show()
```

### Atmospheric extintion.

Once in the atmosphere, the Cherenkov light can suffer absortion and scattering due to several processes:

* Rayleigh scattering:

$$ I = I_0 \frac{8\pi^4 \alpha^2}{\lambda^4 R^2}(1 - \cos^2\theta)$$

where $R$ is the distance to the particle and $\theta$ the scattering angle.

* Absortion by ozone, above 20 km.
* Aerosol, dust. Independent of $\lambda$.

![](images/Cherenkov_NSB_spectra.png)

This processes change the Cherenkov spectrum dependending on the altitude. In ice on the other hand, there is no UV absorption and the Cherenkov spectrum keeps the $1/\lambda^2$ tendency.

## Gamma-rays, Cosmic-Rays and Neutrinos

### Introduction
Both gamma-rays and neutrinos are produced as secondary products of Cosmic-Rays interactions. The dominant channels are:

$$
\begin{aligned}
p\gamma &\rightarrow \Delta^+ \rightarrow \begin{cases}
  p \pi^0 & (2/3)\\
  n \pi^+ & (1/3)
  \end{cases}\\
pp &\rightarrow \begin{cases}
  pp \pi^0 & (2/3)\\
  nn \pi^+ & (1/3)
  \end{cases}
  \end{aligned}$$
 
The same processes occur with neutrons instead of protons leading to $\pi^-$ production. The resulting neutrons can decay or interact. One assumption is that escaping neutrons decay as $n \rightarrow p + e^- + \nu_e$ producing the observed CRs. This is called the **magnetic confiment models** in which the protons are trapped in the magnetic fields and only neutrons escape. The **Waxman-Bachall models** on the other hand assume that some protons escape, and therefore the observed flux of cosmic rays is a lower-limit on the total number of accelerated protons. 
In both scenarios the charged and neutral pions will decay as:

$$\begin{aligned}
\pi^+ &\rightarrow \mu^+ \nu_\mu \rightarrow e^+ \nu_e \bar{\nu}_\mu \nu_\mu\\
\pi^- &\rightarrow \mu^- \bar{\nu}_\mu \rightarrow e^- \bar{\nu}_e \nu_\mu\bar{\nu}_\mu \\
\pi^0 &\rightarrow \gamma\gamma
\end{aligned}$$

Clearly the productions of neutrinos, cosmic-rays and $\gamma$-rays are closely related.

### p-p interactions

For environments where radiation density is low (too few photons) $pp$ interactions dominate over $p\gamma$ interactions. The cross section of $pp$ interactions is almost energy independent $\sigma_{pp} \sim 4 \times 10^{-26}$ cm$^2$ (See [Kelner et al.]("http://arxiv.org/abs/astro-ph/0606058")). The cross section of this process has a threshold given by:

$$E_{th} = m_p + m_\pi(m_\pi + 4m_p)/2m_p \sim 1.2 \mathrm{\; GeV}$$


Therefore most of accelerated protons can interact in the source if there is enough material and the spectra of secondary particles closely follows that of the parent proton spectrum assuming the meson *cooling time* (we usually call *cooling* to any process of energy loss due to radiation) and interaction length are larger than decay time/length (in other words, if the meson decays before loosing energy or interacts).

* If the proton spectrum is **softer** than $\mathrm{ d}N_p/\mathrm{ d}E \sim E^{-2}$, most of the electronmagnetic and neutrino power is in the energy band of 1 GeV. Gamma-ray emission is dominated by the $\pi^0$ decay.

* If the proton spectrum is **harder** than $\mathrm{ d}N_p/\mathrm{ d}E \sim E^{-2}$, most of the energy ouput from proton interactions is at high energy. In this case the main contribution in gamma-ray comes from IC from secondary $e^-e^+$ pairs produced in $\pi^{\pm}$ decays. 


### p-gamma interations

The cross-section of this process has a higher energy threshold than $pp$ interactions given by:

$$E_{th} = \frac{m_p m_{\pi} + m_{\pi}^2}{\epsilon_{ph}} \simeq 7 \times 10^{16} \left[\frac{\epsilon_{ph}}{1\mathrm{\; eV}}\right]^{-1}$$


where $\epsilon_{ph}$ is the target photon energy. Because this threshold only the highest energy protons can efficiently interact with the soft-photon fields. This process is the one typically considered for UHECR and extragalactic sources such as AGNs and Gamma-ray Bursts.

### The Waxman-Bahcall neutrino flux

The neutrino flux from an optical thin (ie transparent for nucleon-meson interactions) source is usually referred as the [Waxman-Bahcall flux](http://journals.aps.org/prd/abstract/10.1103/PhysRevD.64.023002).

To derive it let's assume only the extragalactic CR contribution. The energy density is, as we calculated in Lecture 3 given by:

$$\rho_{CR} = \int E n(E) \mathrm{ d} E =4\pi \int_{E_{min}}^{E_{max}} \frac{E}{c}I(E) \mathrm{ d} E \sim 3\times 10^{-19} \mathrm{\; ergs\; cm^{-3}}$$

where assume the extreme energies of the accelerator to be $E_{max}/E_{min} \sim 10^{3}$. If the source is optically thin for $p\gamma$ and $pp$ interactions then the energy flux of neutrinos cannot be greater than that of cosmic-rays (this can only happen in an optically thick source where cosmic-rays do not escape but only neutrinos do). To estimate a bound then we can therefore assume that the same energy density of cosmic rays ends up in neutrinos and electromagnetic energy:

$$\int E_\nu I_\nu (E_\nu) \mathrm{ d}E_\nu = c \frac{\rho_{CR}}{4\pi}$$

Assuming that the neutrino follows a power law of spectrum with an differential spectral index of 2 and a maximum $E_{max} = 10^{8}$ GeV the produced neutrino flux is:

$$E_\nu^2 I_\nu (E_\nu) \sim 5 \times 10^{-8} \mathrm{ \; GeV\; cm^{-2}\; s^{-1}\; sr^{-1}}$$

The Waxman-Bahcall flux is sometimes referred as a bound, in part because more energy is transfer to the neutron than the charged pion (roughtly a factor 4 times more) and so:

$$E_{\nu_\mu}^2 I_{\nu_\mu} (E_{\nu_\mu}) \sim 1 - 5 \times 10^{-8} \mathrm{ \; GeV\; cm^{-2}\; s^{-1}\; sr^{-1}}$$

The value derived above does not account for several things:

* There are more CR than observed at Earth due to the GZK-effect. It also ignores the evolution of the sources as red-shift $\rightarrow$ **increase the neutrino flux.**
* In $p\gamma$ muon neutrinos (and antineutrinos) from the pion decay $\pi^+ \rightarrow \mu^+ \nu_\mu \rightarrow e^+ \nu_e \bar{\nu}_\mu \nu_\mu$ only receive 1/2 of the energy of the charged pion (assuming each lepton carries the same energy) $\rightarrow$ **decrease the neutrino flux**.

In practice these corrections compensate. The other uncertainty is from where to chose $E_{min}$ ie the transition to Galactic sources. In general we can construct a more generic relation between the CR and neutrino flux of the form of:

$$\rho_{CR}(E_{min}) = n_{\nu/p} \rho_{\nu}(E_{min}) = n_{\nu/p}\int_{E_{min}} n_\nu (E_\nu) E_\nu \mathrm{d} E_\nu$$


$$ n_{\nu/p} 4\pi \int_{E_{min}} \frac{I_\nu (E_\nu)}{c} E_\nu \mathrm{d} E_\nu = 4\pi \int_{E_{min}} \frac{I_p (E_p)}{c} E_p \mathrm{d} E_p $$

where $n_{\nu/p}$ refers to the number of neutrinos per proton interaction. Ignoring the integrals we get the relation:

$$E_\nu I_\nu (E_\nu) \sim n_{\nu/p} E_p I_p (E_p)$$

Using that the energy of the neutrinos will be a fraction $\langle x_{p\rightarrow \nu} \rangle$ of the proton energy we can rewrite it as:

$$I_\nu (E_\nu) \sim n_{\nu/p} \frac{1}{\langle x_{p\rightarrow \nu} \rangle} I_p (E_p)$$

### The neutrino and gamma connection 
#### Extragalactic p-gamma: Energy fraction

Due to isospin the $\Delta^+$ decays more often to $p$ than $n$.
$$
p\gamma \rightarrow \Delta^+ \rightarrow \begin{cases}
p \pi^0 & (2/3)\\
  n \pi^+ & (1/3)
  \end{cases}$$

In both cases, the fraction of energy that goes to the pions is $\langle x_{p\rightarrow\pi}\rangle \sim 0.20$
. Assuming the pion decays:

$$\pi^0 \rightarrow \gamma\gamma, \mathrm{\;and\;} \pi^+ \rightarrow \mu^+ \nu_\mu \rightarrow e^+ \nu_e \bar{\nu}_\mu \nu_\mu$$

We have that:
1. $\gamma$'s take 1/2 of the neutral pion energy. 
2. Leptons take 1/4 of the charge pion energy.

And so:

$$\begin{aligned}
\langle x_{p\rightarrow\nu}\rangle &= \frac{1}{4}\langle x_{p\rightarrow\pi}\rangle =\frac{1}{20}\\
\langle x_{p\rightarrow\gamma}\rangle &= \frac{1}{2}\langle x_{p\rightarrow\pi}\rangle =\frac{1}{10}
\end{aligned}$$

####  Extragalactic p-gamma: Number of particles

If we consider only $\nu_\mu$ we have 2 $\nu_\mu$ per pion decay, as well as 2 $\gamma$'s per pion decay. So the spectra can be related as:

$$\begin{aligned}
    I_{\nu_\mu}(E_{\nu_\mu}) &= 2 \times \frac{1}{3} \frac{1}{\langle x_{p\rightarrow\nu}\rangle} I_{p}(E_{p})\\
    I_{\gamma}(E_{\gamma}) &= 2\times \frac{2}{3} \frac{1}{\langle x_{p\rightarrow\gamma}\rangle}I_{p}(E_{p})
\end{aligned}$$

Let's assume a proton spectrum $I_p(E_p) \propto E_p^{-2}$ and so $I_p(E_p)\propto E_{\nu_\mu}^{-2}\langle x_{p\rightarrow\nu}\rangle^2$

$$\begin{aligned}
    I_{\nu_\mu}(E_{\nu_\mu}) \propto 2 \times \frac{1}{3} \langle x_{p\rightarrow\nu}\rangle E_{\nu_\mu}^{-2} \rightarrow 2 \times \frac{1}{3} \times \frac{1}{20} E_{\nu_\mu}^{-2}\\
    I_\gamma(E_\gamma) \propto 2 \times \frac{2}{3}\langle x_{p\rightarrow\gamma}\rangle  E_\gamma^{-2} \rightarrow  2 \times \frac{2}{3} \times \frac{1}{10} E_{\gamma}^{-2}
\end{aligned}$$

So:

$$I_{\nu_\mu} (E_{\nu_\mu}) \sim \frac{1}{4} I_{\gamma}(E_\gamma)$$


#### Galactic *pp*

In a matter dominated environtment such as Galactic SN shocks CRs interact with the H in the Galactic disk via pp interactions. As we saw these interactions have a lower threshold than $p\gamma$. Let's consider the reaction:

$$p + p \rightarrow p + p + \pi^0 + \pi^+ \pi^-$$
  
where we assume that pions are produced with the same probability (1/3). Doing the same calculation as before we get that:

$$\begin{aligned}
    I_{\nu_\mu}(E_{\nu_\mu}) &\propto 2 \times \frac{1}{3} \langle x_{p\rightarrow\nu}\rangle E_{\nu_\mu}^{-2} \rightarrow 2 \times \frac{2}{3} \times \frac{1}{20} E_{\nu_\mu}^{-2}\\
    I_\gamma(E_\gamma) &\propto 2 \times \frac{2}{3}\langle x_{p\rightarrow\gamma}\rangle  E_\gamma^{-2} \rightarrow  2 \times \frac{1}{3} \times \frac{1}{10} E_{\gamma}^{-2}
\end{aligned}$$


#### Astrophysical Neutrino Oscillations

In the discussion above we focused on muon neutrinos, however we ignored the fact that neutrino oscillate. We saw that the probability of neutrino flavor for $\delta = 0$ can be written as: 

$$\begin{aligned}
P(\nu_\alpha \rightarrow \nu_\beta) &=\sum_j\sum_i U_{\alpha i}U^*_{\beta i}U^*_{\alpha  j}U_{\beta j}e^{-i\frac{\Delta m^2L}{2E}}\\
&= \delta_{\alpha\beta}  -  4{\sum_{i>j}\mathrm{ Re}(U_{\alpha i}^{*}U_{\beta i}U_{\alpha j}U_{\beta j}^{*}})\sin^{2}(\frac{\Delta m_{ij}^{2}L}{4E})
\end{aligned}$$

For a non-monochromatic neutrino beam, the probability has to be averaged over the spectrum. The $\sin$ term will be averaged to 0.5 for large distances $L$. And thus the probability does not depend on time and can be written as a matrix:

$$P(\nu_\alpha \rightarrow \nu_\beta) = \sum_j |U_{\alpha  j}|^2 |U_{\beta j}|^2 $$

### Tutorial II: Calculation of astrophysical neutrino oscillations

```{python}
import numpy as np
import scipy as sp

def PMNS_Factory(t12, t13, t23, d):
    s12 = np.sin(t12)
    c12 = np.cos(t12)
    s23 = np.sin(t23)
    c23 = np.cos(t23)
    s13 = np.sin(t13)
    c13 = np.cos(t13)
    cp  = np.exp(1j*d)
    return np.array([[ c12*c13, s12*c13, s13*np.conj(cp) ],
                  [-s12*c23 - c12*s23*s13*cp, c12*c23 - s12*s23*s13*cp, s23*c13],
                  [ s12*s23 - c12*s23*s13*cp,-c12*s23 - s12*c23*s13*cp, c23*c13]])

##Probability of flavor change when L->inf
def Prob(a, b, U):
    """
    Gives the oscillation probability for nu(a) -> nu(b)
    for PMNS matrix U, and L in km and E in GeV
    """
    s = 0
    for i in range(3):
            s += (np.conj(U[a,i])*U[b,i]*U[a,i]*np.conj(U[b,i])).real
    return s


def ProbMatrix(U):
    return np.array([[Prob(0, 0, U), Prob(0, 1, U), Prob(0,2,U)],
                     [Prob(1, 0, U), Prob(1, 1, U), Prob(1,2,U)],
                     [Prob(2, 0, U), Prob(2, 1, U), Prob(2,2,U)]])
                     

t12 = np.arcsin(0.306**0.5)
t13 = np.arcsin(0.0251**0.5)
t23 = np.arcsin(0.42**0.5)
U = PMNS_Factory(t12, t13, t23, 0)
```
The probability of a neutrino flavor fector of $(\nu^{source}_e, \nu^{source}_\mu, \nu^{source}_\tau)$ to change into a flavor vector $(\nu^{Earth}_e, \nu^{Earth}_\mu, \nu^{Earth}_\tau)$ is given by:

$$\left(\nu^{Earth}_e \\ \nu^{Earth}_\mu \\ \nu^{Earth}_\tau\right) = P_{\alpha\beta} \left(\nu^{Source}_e \\ \nu^{Source}_\mu \\ \nu^{Source}_\tau\right)$$

Assuming at the source the flavor ratio is (1:2:0) we have that:

```{python}
Prob(0, 0, U) + Prob(1, 0, U) + Prob(2, 0, U)
```

```{python}
source = np.array([1, 1, 1])
P = ProbMatrix(U)
Earth = np.dot(P, source)
print (Earth)
```

Thus, almost equal number of eletron, muon and tau astrophysical neutrinos are expected to be observed at Earth due to oscillations. More info at [arXiv:hep-ph/0005104](http://arxiv.org/abs/hep-ph/0005104)


### Gamma-ray neutrino relation
After oscillations the neutrino and gamma-rays relations are given by:

$$\frac{\mathrm{ d}N_\nu}{\mathrm{ d}E_\nu} = \frac{1}{2}\frac{\mathrm{ d}N_\gamma}{\mathrm{ d}E_\gamma} \mathrm{\; for\;} p + p$$

$$\frac{\mathrm{ d}N_\nu}{\mathrm{ d}E_\nu} = \frac{1}{8}\frac{\mathrm{ d}N_\gamma}{\mathrm{ d}E_\gamma} \mathrm{\; for\;} p + \gamma$$

Assuming an $E^{-2}$ spectrum.

###  Neutrino Astronomy

### Diffuse flux of Astrophysical Neutrinos

The first detection of high-energy neutrinos of cosmic origin in 2013 by the IceCube Neutrino Observatory opened a new window to the non-thermal processes in our universe. The  first  strong  evidence  for  a  cosmic  neutrino  component  came  from a  search  using  data  from  May  2010  to  April  2012  [35],  where  two  shower-like events from interactions within the detector with energies above 1 PeV were discovered.  A follow-up search for events starting in the detector with more than 30 TeV deposited energy that utilized the same dataset identified 25 additional high-energy events.  The spectrum and zenith angle distribution of the events was incompatible with the hypothesis of an atmospheric  origin  at > $4\sigma$. IceCube  has  since  collected  independent  evidence for an astrophysical neutrino signal by analyzing different event signatures.

#### Starting Events

Neutrino interactions are identified in IceCube by searching for an interaction  vertex  within  the  instrumented  volume.   This  search  is  sensitive  to both shower-like and track-like events.  Since the main background for this
search is comprised of muons from CR air showers, the rejection strategy is to identify Cherenkov photons from a track entering the detector.  For that, the outer parts of the instrumented volume are assigned to a “veto” region. An event is rejected if a certain number of Cherekov photons are found in this veto region at earlier times than the photons produced at the interaction vertex. The energy threshold for this analysis is about $E_\nu \sim 30$ TeV.

#### Through-going muons

Muons  produced  in  CC  neutrino  interactions  far  outside  the  detector can still reach the instrumented volume to produce track-like events.  Even at  1  TeV  a  muon  can  penetrate  several  kilometers  of  ice  before  it  stops and  decays.   This  allows  observation  of  high-energy  neutrino  interactions from  a  much  larger  volume  than  the  instrumented  one,  thereby  substantially increasing the effective area of the detector.  



#### The spectral fit

The results of a combined analysis fits the neutrino flux to a power-law between 27 TeV and 2 PeV consistent
with an unbroken power law with a best-fit spectral index of $-2.49 \pm 0.08$ given by:

$$E^2\Phi(E) = 2.06^{+0.35}_{-0.26} \times 10^{-8} \left(\frac{E}{100\;\mathrm{TeV}}\right)^{-0.46\pm 0.12}\; \mathrm{GeV\;s}^{-1}\;\mathrm{sr}^{-1}\mathrm{ cm}^{-2}.$$



However using only the high energy through-going muons (abouve 200 TeV) yields  a preferred spectral index of $-2.13\pm 0.13$


### The Search for Point Sources

In the case where the cosmic neutrino flux is dominated by bright individual sources, they should be detectable as a local excess of events on the sky  with  respect  to  the  atmospheric  neutrino  and  diffuse  cosmic  neutrino
background.  The sensitivity of a search for such features depends crucially on the precision by which the direction of the neutrinos can be reconstructed from the data, i.e.  on the detector angular resolution. No indication for a neutrino point source has been found in the IceCube data so far. The null result of a point-source of neutrinos, can be transformed into an flux upper limit at a given confidence level. This upper limits represents the neutrino flux that we can be certain to exclude, since IceCube did not see a point source.

![Source: IceCube](images/upperlimits.png)

### The Olbers' Paradox

Altough the most famous formulation of the problem comes from Henrich Olbers (1826), probably it was Kepler in 1610 the first to note that the most obvious observation, the night sky is dark, has very important consequences.

![](images/olber.svg)

The idea is quite simple, suppose there is a source population with typical luminosity $L$ in ergs/s and a number density of $n$, then the total power emitted per unit area will be:

$$ F = \int L n \frac{dV}{4\pi^2} = \frac{1}{4\pi}\int L n \mathrm{ d}\Omega \mathrm{ d}r$$

Integrating over all distances we can obtain the energy per steradian per second, and assuming the luminosity is independent of distance as well as number density we have that:

$$\frac{\mathrm{ d} F}{\mathrm{ d}\Omega} = \frac{1}{4\pi} L n \int_0^{\infty} \mathrm{ d}r \rightarrow \infty$$

The sky should be bright! The solution of this puzzle is the fact the Universe is dynamic and time dependent! In other words, if the Universe is expanding the radiation from increasingly distant sources is increasingly less. Also stars seems to have had a cosmological evolution, for example, there are more quasars per unit volume at $z \sim 2$ than now.

Although the Olbers' paradox is no more a paradox, it represents the *problem* that arises with neutrino astronomy. Since the extragalactic space is completely transparent for neutrinos, the flux of neutrinos that might arrive at Earth will have a significant contribution from very distant and faint sources. Let's assume now a source population with typical neutrino luminosity $L\nu(E)$ and with a number density population given by:

$$n(z) = n_0 (1+z)^m$$

where $n_0$ is the *local density* of the source population, (ie the population close to our epoch $z = 0$). The parameter $m$ describes the source cosmological evolution (ie, when sources to appear in the history of the Universe, and how they evolved). Typical values are $m= 3$ for star–formation–like evolution and $m=0$ for no evolution.

Since the Universe expands and sources move with the *Huble flow* we are going to use the comoving line of sight distance, defined as (see Lecture 2):

$$D_c(z) = \int_{t}^{t_0} c\mathrm{ d} t = \frac{c}{H_0} \int^z_0 \frac{\mathrm{ d}z^\prime}{E(z^\prime)}$$

where we introduced the function:

$$E(z)\equiv \sqrt{\Omega_M(1+z)^4 + \Omega_r(1+z)^5 + \Omega_k(1+z)^3 +\Omega_\Lambda(1+z)}$$

revisiting the formula of the energy rate of neutrinos per steroradian we have:

$$\frac{\mathrm{ d} F_\nu}{\mathrm{ d}\Omega} = \frac{1}{4\pi} \frac{c}{H_0}\int_0^{\infty} \frac{L_\nu(E_\nu) n_0(1+z)^m}{E(z)} \mathrm{ d}z$$

The expresion above needs an extra correction. We assumed that energy emitted by the source will be the same at the arrival, however energy will be red-shifted according to $E_\nu (1 + z)$ so the formula it's technically:

$$\frac{\mathrm{ d} F_\nu}{\mathrm{ d}\Omega} = \frac{1}{4\pi} \frac{c}{H_0}\int_0^{\infty} \frac{L_\nu(E_\nu(1+z)) n_0(1+z)^m}{E(z)} \mathrm{ d}z$$

Assuming the luminosity follows a power law with, $L_\nu \propto E^{-\gamma}$, we can rewrite the expression as:

$$\frac{\mathrm{ d} F_\nu}{\mathrm{ d}\Omega} = \xi \frac{c}{H_0} \frac{L_\nu(E_\nu) n_0}{4\pi} $$

where the unit-less parameter $\xi$ is the integral that contains information on the expansion and cosmological evolution of the sources and the spectral index of the sources defined as:

$$\xi = \int_0^{\infty}\frac{(1+z)^{(m - \gamma)}\mathrm{ d} z}{E(z)}$$

Assuming an spectral index of 2, and expressing it as function of the scale factor knowing that:

$$\frac{\mathrm{ d}z}{1+z} = - \frac{\mathrm{ d}a}{a} \rightarrow \mathrm{ d}z = -\frac{\mathrm{ d}a}{a^2}$$ 

and that $z = \infty \rightarrow a = 0$,  $z = 0 \rightarrow a = 1$, we can rewrite the integral as:

$$\xi = \int_0^{1}\frac{a^{-m} \mathrm{ d} a}{E(a)}$$

Where it will depend on the cosmic evolution of the sources. Typical star forming rate evolution  (SFR) has an evolution of $m = 3.4$ in our local universe $z<1 $ and $m=-0.3$ for $ 1< z< 4$ and $m=-3.5$ elsewhere.


### Tutorial III: Calculate the value of $\xi$ 

We are going to calculate the value of the parameter $\xi$ for different cosmological evolution of the sources. The SFR evolution is given by the following broken power law formula:

```{python}
def rho(z):
    if z < 1.:
        return (1. + z)**3.4
    elif z >= 1. and z <= 4.:
        return (1+1.)**3.4 * ((1.+z)/(1.+1.))**-0.3
    else:
        return (1.+1.)**3.4*((1.+4.)/(1.+1.))**-0.3*((1.+z)/(1.+4.))**-3.5
    
ax = plt.subplot(111)

z = np.linspace(0, 7, 1000)
vrho = np.vectorize(rho)

ax.plot(z, vrho(z))
ax.set_xlabel("z")
ax.set_ylabel("$n_{SFR}(z)/n_0$")
ax.grid()

from astropy.cosmology import Planck13 as cosmo
from scipy import integrate

def xi(z):
    return cosmo.H0.value/cosmo.H(z).value * rho(z) * (1 + z)**(-2)

integral = integrate.quad(lambda z: xi(z), 0., np.inf)[0]

print(r"$\xi$ = %.2f for an evolution of SFR" %(integral))

integral = integrate.quad(lambda z: cosmo.H0.value/cosmo.H(z).value  * (1 + z)**(-2), 0., 2)[0]

print(r"$\xi$ = %.2f for no cosmological evolution up to redshift z < 2" %(integral))


```


Therefore the parameter $\xi$ varies between $0.5\sim 3$. We can equate this total neutrino flux per steroradian to the flux observed by IceCube (assuming an spectral index of 2):

$$\xi \frac{c}{H_0} \frac{L_\nu(E_\nu) n_0}{4\pi} = E^2 \Phi_\nu \sim 2.06 \times 10^{-8} \frac{\mathrm{ GeV}}{\mathrm{ cm}^2\mathrm{ s\;} \mathrm{ sr}}$$

```{python}
#I'm going to use units to avoid stupid mistakes
import astropy.units as u
from astropy import constants as const
from IPython.display import display, Markdown

xi = 0.48

icecube_flux = 2.06e-8 * u.GeV/u.cm**2/u.s/u.sr

Ln = icecube_flux * cosmo.H0.to(1/u.s)/const.c.to(u.Mpc/u.s) * 4 * np.pi * u.sr * xi
Ln = Ln.to(u.erg/u.Mpc**3/u.yr)

display(Markdown(r"$n_0 L_\nu \sim$ {0:.1e} {1}".format(Ln.value, Ln.unit.to_string("latex"))))
```

ie, it reaches the value of:

$$n_0 L_\nu \sim 10^{43} \frac{\mathrm{erg}}{\mathrm{Mpc}^3\mathrm{yr}}$$

note that this is almost independent of the value of $xi$. We can represent this relation in a diagram now called Kowalski's plot:

![Source: Taken from [arxiv:1411.4385](https://arxiv.org/pdf/1411.4385.pdf)](images/kowalski2.png)

Constrains can also be obtained from the point-source limits. The argument is as follows, if the source population that is responsible of the diffuse astrophysical flux observed in IceCube, is rate (has a low density) then the closest of these sources should have provided a signal in the point-source analysis. 
Let's assume that $d$ is the distance to the nearest source for a source population with local density $n_0$ so:

$$n_0 \frac{4}{3} \pi d^3 = 1$$

since there is 1 source in an sphere of radius $d$. We can estimate the closest distance to a source of this population as:

$$ d = \left(\frac{1}{\frac{4}{3}\pi n_0}\right)^{1/3} \propto n_0^{-1/3}$$

and thus the estimated neutrino flux for this single point-source is: 

$$E^2 \Phi^{ps}_\nu = \frac{L_\nu}{4\pi d^2} \sim L_\nu n_0^{2/3}$$

A typical value of the neutrino point-source upper limits can be obtained for the Northern sky as:

$$E^2 \Phi^{u.l.}_\nu \leq 2 \times 10^{-9} \mathrm{ GeV} \mathrm{ cm}^{-2}\mathrm{ s}^{-1} $$

so we have the 2 constrains together:


$$n_0^{-1/3} \leq \frac{\Phi^{u.l.}}{10^{43}\frac{\mathrm{erg}}{\mathrm{Mpc}^3\mathrm{yr}}}$$

which leads to the following condition on the local density of sources from the point-source upper limits:

```{python}
flux_upperlimit = 2e-9 * u.GeV/u.cm**2 / u.s

n0 = np.power(flux_upperlimit/Ln, -3)
n0 = n0.to(u.Mpc**-3)

display(Markdown(r"$n_0 \geq$ {0:.1e} {1}".format(n0.value, n0.unit.to_string("latex_inline"))))
```

#### References
* High energy neutrinos in the context of multimessenger astrophysics. J. Becker [arXiv:0710.1557v2](https://arxiv.org/abs/0710.1557)
* Cosmic Neutrinos from the Sources of Galactic and Extragalactic Cosmic Rays. F. Halzen
[arxiv:0611915](https://arxiv.org/pdf/astro-ph/0611915.pdf)
